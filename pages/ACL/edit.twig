<div id="div1">
    <card>
        <card-body>
            <form>
                <div class="form-group">
                    <label>{{'Module'|trans}}</label>
                    <select class="form-control form-control-sm" v-model="module">
                        <option></option>
                        <option v-for="m in modules" :value="m" v-text="m.name"></option>
                    </select>
                </div>

                <div class="form-group">
                    <label>{{'User group'|trans}}</label>
                    <select class="form-control form-control-sm" v-model="usergroup" @change="changeUserGroup">
                        <option v-for="ug in usergroups" :value="ug" v-text="ug.name"></option>
                    </select>
                </div>

                <div class="form-group">
                    <label>{{'User'|trans}}</label>
                    <select class="form-control form-control-sm" v-model="user" @change="changeUser">
                        <option v-for="u in users" :value="u" v-text="u.first_name + ' ' + u.last_name + ' (' + u.username + ')'"></option>
                    </select>
                </div>

                <div class="form-group">

                    <label>SPECIAL USER</label>
                    <select class="form-control form-control-sm" v-model="special_user" @change="changeSpecialUser">
                        <option v-for="(k,v) in special_users" :value="v" v-text="k"></option>
                    </select>
                </div>
            </form>


            <table class="table table-sm" v-if="data1.action">
                <thead>
                    <tr>
                        <th>Action</th>
                        <th>Allow</th>
                        <th>Deny</th>
                    </tr>
                </thead>

                <tbody>
                    <tr v-for="(a,index) in data1.action">
                        <td v-text="a.action"></td>
                        <td>
                            <div class="icheck-primary d-inline ml-2">
                                <input type="checkbox" :id="'action-allow-'+index" v-model="a.allow" @change="actionChecked(a)">
                                <label :for="'action-allow-'+index"></label>
                            </div>
                        </td>
                        <td>
                            <div class="icheck-primary d-inline ml-2">
                                <input type="checkbox" :id="'action-deny-'+index" v-model="a.deny" @change="actionChecked(a)">
                                <label :for="'action-deny-'+index"></label>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>


            <table class="table table-sm" v-if="data1.path">
                <thead>
                    <tr>
                        <th>Path</th>
                        <th>Allow</th>
                        <th>Deny</th>
                    </tr>
                </thead>

                <tbody>
                    <tr v-for="(a,index) in data1.path">
                        <td v-text="a.path"></td>
                        <td>
                            <div class="icheck-primary d-inline ml-2">
                                <input type="checkbox" :id="'path-allow-'+index" v-model="a.allow" @change="actionChecked(a)">
                                <label :for="'path-allow-'+index"></label>
                            </div>
                        </td>
                        <td>
                            <div class="icheck-primary d-inline ml-2">
                                <input type="checkbox" :id="'path-deny-'+index" v-model="a.deny" @change="actionChecked(a)">
                                <label :for="'path-deny-'+index"></label>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <table class="table table-sm" v-if="allowAddCustom()">
                <thead>
                    <tr>
                        <th><button class="btn btn-xs btn-primary" @click="custom={allow:1,deny:0}"><i class="fa fa-fw fa-plus"></i></button></th>
                        <th>Path</th>
                        <th>Allow</th>
                        <th>Deny</th>
                    </tr>
                </thead>

                <tbody>
                    <tr v-if="custom">
                        <td><button @click.prevent="onSaveCustom" class="btn btn-xs btn-success"><i class="fa fa-fw fa-check"></i></button>
                            <button @click.prevent="custom=null" class="btn btn-xs btn-warning"><i class="fa fa-fw fa-undo"></i></button></td>
                        <td><input type="text" class="form-control input-sm" v-model="custom.path" /></td>
                        <td>
                            <div class="icheck-primary d-inline ml-2">
                                <input type="checkbox" id="cb1" v-model="custom.allow">
                                <label for="cb1"></label>
                            </div>
                        </td>
                        <td>
                            <div class="icheck-primary d-inline ml-2">
                                <input type="checkbox" v-model="custom.deny">
                                <label></label>
                            </div>
                        </td>

                    </tr>
                    <tr v-for="a in data1.custom">
                        <td><button @click.prevent="delAction(a)" class="btn btn-xs btn-danger"><i class="fa fa-fw fa-times"></i></button></td>
                        <td v-text="a.path"></td>
                        <td>
                            <div class="icheck-primary d-inline ml-2">
                                <input type="checkbox" value="">
                            </div>

                            <!-- icheck v-model="a.allow" @input="actionChecked(a)" value="1"></icheck -->
                        </td>
                        <td>
                            <!-- icheck v-model="a.deny" @input="actionChecked(a)" value="1"></icheck -->
                        </td>
                    </tr>
                </tbody>
            </table>
        </card-body>
    </card>
</div>

<script>
    var vm = new Vue({
        el: "#div1",
        data: {
            custom: null,
            module: null,
            modules: [],
            usergroups: [],
            users: [],
            usergroup: null,
            user: null,
            data1: [],
            special_users: [],
            special_user: null
        },
        created() {
            this.$http.get(window.location + "/data").then(resp => {
                this.modules = resp.data.module;
                this.usergroups = resp.data.usergroup;
                this.users = resp.data.user;
                this.special_users = resp.data.special_user;
            });
        }, watch: {
            module() {
                this.getValue();
            }
        }, methods: {
            allowAddCustom() {
                if (this.user) return true;
                if (this.usergroup) return true;

                return false;

            },
            actionChecked(a) {
                let p = {};
                if (this.module) {
                    p.module = this.module.name;
                }

                if (this.usergroup) {
                    p.usergroup_id = this.usergroup.usergroup_id
                }

                if (this.user) {
                    p.user_id = this.user.user_id;
                }

                if (this.special_user) {
                    p.special_user = this.special_user;
                }

                p.value = a;
                return this.$http.post(window.location.toString(), p);
            },
            getValue() {
                let p = {};
                if (this.module) {
                    p.module = this.module.name;
                }

                if (this.usergroup) {
                    p.usergroup_id = this.usergroup.usergroup_id
                }

                if (this.user) {
                    p.user_id = this.user.user_id;
                }

                if (this.special_user) {
                    p.special_user = this.special_user;
                }

                this.$http.get(window.location + "/getValue", {
                    params: p
                }).then(resp => {
                    this.data1 = resp.data;
                });

            },
            changeSpecialUser() {
                this.user = null;
                this.usergroup = null;
                this.getValue();
            },
            changeUserGroup() {
                this.user = null;
                this.special_user = null;
                this.getValue();
            }, changeUser() {
                this.usergroup = null;
                this.special_user = null;
                this.getValue();
            }, onSaveCustom() {
                this.actionChecked(this.custom).then(resp => {
                    this.custom = null;
                    this.getValue();
                });

            }, delAction(a) {
                let p = {};
                if (this.module) {
                    p.module = this.module.name;
                }

                if (this.usergroup) {
                    p.usergroup_id = this.usergroup.usergroup_id
                }

                if (this.user) {
                    p.user_id = this.user.user_id;
                }

                p.value = a;

                this.$http.post(window.location + "/delACL", p).then(resp => {
                    this.getValue();
                });
            }

        }

    });
</script>